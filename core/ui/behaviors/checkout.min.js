/*!
 * checkout.js - Shopp catalog behaviors library
 * Copyright Â© 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(){var d=jqnc(),m=false,e=d(".sameaddress"),c=d("#submit-login-checkout"),n=d("#account-login-checkout"),j=d("#password-login-checkout"),l=d("#guest-checkout"),k=d("#checkout.shopp"),q=d("#checkout.shopp [name=paymethod]"),a=d("#billing-locale"),s=d("#billing-card"),o=d("#billing-cardtype"),u=d(".payoption-button"),b=d(".payoption-"+decodeURIComponent(d_pm)),r=u.find("input"),p=d("#shopp-checkout-function"),h=d("#checkout.shopp li.locale");if(k.find("input[name=checkout]").val()=="process"){u.hide();if(b.length==0){b=d(".payoption-0")}b.show();q.change(g).change()}d.fn.extend({disableSubmit:function(){var v=d(this);v.data("timeout",setTimeout(function(){v.enableSubmit();alert($co.error)},$co.timeout*1000));return v.data("label",v.val()).prop("disabled",true).addClass("disabled").val($co.submitting)},enableSubmit:function(){var v=d(this);clearTimeout(v.data("timeout"));return v.prop("disabled",false).removeClass("disabled").val(v.data("label"))}});r.on("click",function(){d(this).disableSubmit();setTimeout(function(){k.submit()},1)});k.on("shopp_validate",function(){if(!f()){k.data("error",[$co.badpan,s.get(0)])}if(k.data("error").length>0){r.enableSubmit()}});s.change(f);o.change(function(){var w=new String(o.val()).toLowerCase(),v=paycards[w];d(".paycard.xcsc").attr("disabled",true).addClass("disabled");if(!v||!v.inputs){return}d.each(v.inputs,function(x,y){d("#billing-xcsc-"+x).attr("disabled",false).removeClass("disabled")})}).change();o.change(function(){var v=new String(o.val()).toLowerCase();for(var w in paycards){if(k.hasClass("cardtype-"+w)){k.removeClass("cardtype-"+w)}}k.addClass("cardtype-"+v)}).change();if(a.children().size()==0){h.hide()}c.click(function(v){k.unbind("submit.validate").bind("submit.validlogin",function(x){var w=false;if(""==j.val()){w=[$co.loginpwd,j]}if(""==n.val()){w=[$co.loginname,n]}if(w){x.preventDefault();k.unbind("submit.validlogin").bind("submit.validate",function(y){return validate(this)});alert(w[0]);w[1].focus().addClass("error");return false}p.val("login")})});d("#billing-country, .billing-state, #shipping-country, .shipping-state").bind("change.localemenu",function(y,B){var A=e.is(":checked")?e.val():false,z="shipping"==A?d("#billing-country").val():d("#shipping-country").val(),x="shipping"==A?d('.billing-state[disabled!="true"]').val():d('.shipping-state[disabled!="true"]').val(),C=z+x,w,v;if(B||!a.get(0)||(!A&&(d(this).is("#billing-country")||d(this).is(".billing-state")))){return}a.empty().attr("disabled",true);if(locales&&(v=locales[C])||(v=locales[z])){w+="<option></option>";d.each(v,function(E,D){w+='<option value="'+D+'">'+D+"</option>"});d(w).appendTo(a);a.removeAttr("disabled");h.show()}});l.change(function(v){var w=k.find("input.passwords"),x=[];d.each(w,function(){x.push("label[for="+d(this).attr("id")+"]")});x=k.find(x.join(","));if(l.is(":checked")){w.setDisabled(true).hide();x.hide()}else{w.setDisabled(false).show();x.show()}}).trigger("change");d("#shopp form").on("change",".shipmethod",function(){if(d.inArray(d("#checkout #shopp-checkout-function").val(),["process","confirmed"])!=-1){var x=".shopp-cart.cart-",A="span"+x,y="input"+x,z=["shipping","tax","total"],D=[],E={},v=0,C=".shopp .shipmethod, .payoption-button input",B=d(this),w=function(){d(C).attr("disabled",true);d.getJSON($co.ajaxurl+"?action=shopp_ship_costs&method="+B.val(),function(F){if(!F&&v++<2){return setTimeout(w,1000)}d(C).attr("disabled",false);d.each(z,function(H,G){if(!F||undefined==F[G]){d(A+G).html(E[G]);return}d(A+G).html(asMoney(new Number(F[G])));d(y+G).val(new Number(F[G]))})})};d.each(z,function(G,F){D.push(A+F);E[F]=d(A+F).html()});if(!c_upd){c_upd="?"}d(D.join(",")).html(c_upd);w()}else{d(this).parents("form").submit()}});d(window).load(function(){d(document).trigger("shopp_paymethod",[q.val()])});function g(A){var z=d(this),y=decodeURIComponent(d(this).val()),v=d(".payoption-"+y),x="",w=false;if(this!=window&&z.attr&&"radio"==z.attr("type")&&!z.is(":checked")){return}d(document).trigger("shopp_paymethod",[y]);u.hide();if(v.length==0){v=d(".payoption-0")}if(pm_cards[y]&&pm_cards[y].length>0){k.find(".payment,.paycard").show();k.find(".paycard.disabled").attr("disabled",false).removeClass("disabled");if(typeof(paycards)!=="undefined"){d.each(pm_cards[y],function(B,C){if(!paycards[C]){return}w=paycards[C];x+='<option value="'+w.symbol+'">'+w.name+"</option>"});o.html(x).change()}}else{k.find(".payment,.paycard").hide();k.find(".paycard").attr("disabled",true).addClass("disabled")}v.show()}function f(){if(s.length==0){return true}if(s.attr("disabled")){return true}var w=s.val().replace(/\D/g,""),y=q.filter(":checked").val()?q.filter(":checked").val():q.val(),x=false;if(!y){y=decodeURIComponent(d_pm)}if(s.val().match(/(X)+\d{4}/)){return true}if(!pm_cards[y]){return true}d.each(pm_cards[y],function(v,A){var z=paycards[A],B=new RegExp(z.pattern.substr(1,z.pattern.length-2));if(w.match(B)){x=z.symbol;return o.val(x).change()}});if(!t(w)){return false}return x}function t(w){w=w.toString().replace(/\D/g,"").split("").reverse();if(!w.length){return false}var v=0;for(i=0;i<w.length;i++){w[i]=parseInt(w[i],10);v+=i%2?2*w[i]-(w[i]>4?9:0):w[i]}return(v%10)==0}});if(!locales){var locales=false};