/*
 * One Click Upload - jQuery Plugin
 * Copyright Â© 2008 Michael Mitchell - http://www.michaelmitchell.co.nz
 */
(function($){$.fn.upload=function(options){options=$.extend({name:"file",enctype:"multipart/form-data",action:"",accept:false,maxfilesize:false,autoSubmit:true,onSubmit:function(){},onComplete:function(){},onSelect:function(){},params:{}},options);return new $.ocupload(this,options)};$.ocupload=function(element,options){var self=this,id=new Date().getTime().toString().substr(8),iframe=$('<iframe id="iframe'+id+'" name="iframe'+id+'" />').css({display:"none"}),form=$('<form method="post" enctype="'+options.enctype+'" action="'+options.action+'" target="iframe'+id+'" />').css({margin:0,padding:0}).submit(function(e){if(e){e.stopPropagation()}}),input=$('<input name="'+options.name+'" type="file" />').css({position:"absolute",display:"block",opacity:0}),ep=element.parent(),container=element.wrap("<div />").parent().appendTo($("body"));elementHeight=element.outerHeight(true);elementWidth=element.outerWidth(true);container.appendTo(ep);if(options.maxfilesize){$('<input type="hidden" name="MAX_FILE_SIZE" value="'+options.maxfilesize+'" />').appendTo(form)}form.append(input);element.after(form).after(iframe);container=element.parent().css({position:"relative",height:(elementHeight)+"px",width:(elementWidth)+"px",overflow:"hidden",cursor:"pointer",margin:0,padding:0});input.css({width:elementWidth+"px",height:elementHeight+"px",marginTop:-elementHeight+"px",marginLeft:"0px",fontSize:"2em"});input.change(function(){if(this.value==""){return false}if($.ua.msie){if(this.firedChange){return this.firedChange=false}this.firedChange=true}self.onSelect();if(self.autoSubmit){self.submit()}});$.extend(this,{autoSubmit:true,onSubmit:options.onSubmit,onComplete:options.onComplete,onSelect:options.onSelect,filename:function(){return input.attr("value")},params:function(params){var params=params?params:false;if(params){options.params=$.extend(options.params,params)}return options.params},name:function(name){var name=name?name:false;if(name){input.attr("name",value)}return input.attr("name")},action:function(action){var action=action?action:false;if(action){form.attr("action",action)}return form.attr("action")},enctype:function(enctype){var enctype=enctype?enctype:false;if(enctype){form.attr("enctype",enctype)}return form.attr("enctype")},accept:function(accept){var accept=accept?accept:false;if(accept){form.attr("accept",accept)}return form.attr("accept")},set:function(obj,value){var value=value?value:false;function option(action,value){switch(action){default:throw new Error("[jQuery.ocupload.set] '"+action+"' is an invalid option.");break;case"name":self.name(value);break;case"action":self.action(value);break;case"enctype":self.enctype(value);break;case"params":self.params(value);break;case"autoSubmit":self.autoSubmit=value;break;case"onSubmit":self.onSubmit=value;break;case"onComplete":self.onComplete=value;break;case"onSelect":self.onSelect=value;break}}if(value){option(obj,value)}else{$.each(obj,function(key,value){option(key,value)})}},submit:function(){this.onSubmit();var oa=form.attr("action").split("?"),url=oa[0],qp=oa[1]?oa[1].split("&"):[],fparams={},action=false;$.each(qp,function(i,pair){var kv=pair.split("=");if(kv.length==2&&!options.params[kv[0]]){fparams[kv[0]]=kv[1]}});action=url+"?"+(""!=$.param(fparams)?$.param(fparams)+"&":"")+$.param(options.params);form[0].setAttribute("action",action);form.submit();iframe.unbind().load(function(){var myFrame=document.getElementById(iframe.attr("name")),response=$(myFrame.contentWindow.document.body).text();self.onComplete(response)})}})}})(jQuery);