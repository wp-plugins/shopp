/*
 * editor.js - Membership editor behaviors
 * Copyright Â© 2011 by Ingenesis Limited. All rights reserved.
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(){var d=jQuery,f=[],a=d("#rules"),b=0;postboxes.add_postbox_toggles("shopp_page_shopp-memberships");d(".if-js-closed").removeClass("if-js-closed").addClass("closed");d(".postbox a.help").click(function(){d(this).colorbox({iframe:true,open:true,innerWidth:768,innerHeight:480,scrolling:false});return false});function c(u,o,k,p,l){var m=jQuery,v=this,i=b++,n=false,t=rule_types[o],h=rule_groups[o.substr(0,o.indexOf("_"))],g=m.tmpl("panelUI",{label:h+" "+t,type:"rule "+o}),s=g.find("div.ui"),r=g.find("button.delete").hide().click(function(){if(!confirm(DELETE_RULE_PROMPT)){return false}u.trigger("rule-change",[o,n.find("option:selected").attr("class"),true]);g.fadeRemove()}),q=g.find("div.label").hover(function(){r.show()},function(){r.fadeOut("fast")}),n=m.tmpl("accessMenu",{name:"stages["+p+"][rules]["+o+"]["+i+"][access]"}).appendTo(s).find("select.access").change(function(){var w=n.find("option:selected").attr("class");if(n.val().indexOf("-all")==-1){j.ui.show()}else{j.ui.hide()}u.trigger("rule-change",[o])}),j=new SearchSelector(o,s,sugg_url,"stages["+p+"][rules]["+o+"]["+i+"][content]","Type the name of the "+h+" "+t+" to add.","membership");if(k!==false){n.val(k)}else{n.val}if(l){m.each(l,function(x,w){j.ui.prepend(j.newItem(x,w))})}if(!k){k=n.val()}g.appendTo(u);if(!l){n.change()}return this}function e(n,y){f.push(this);var k={},u=f.length,l=(f.length>1?STAGES_LABEL:STAGE_LABEL),q=d.tmpl("panelUI",{type:"stage"}),x=(typeof y=="undefined"||typeof y.id=="undefined"?"":y.id),r=d.tmpl("stagePanelControls",{index:u,id:x}).appendTo(q),s=q.find("div.ui"),p=d("<ul/>").appendTo(s),w=q.find("div.label"),i=function(A,z){new c(p,A,false,u)},v=q.find("select.content").change(function(){var z=d(this);i(z.val());z.val("")}),o=r.find("span.schedule").hide(),h=q.find("select.period"),g=q.find("select.interval").change(function(){var C=d(this),B=bill_periods[0],A=h.find("option:first").html(),z=h.val();if(C.val()=="1"){B=bill_periods[1]}if(A==B[0].label){return}h.html("");d.tmpl("billPeriodOptions",B).appendTo(h);h.val(z)}).change(),t=q.find("input.advance").change(function(){if(t.attr("checked")){o.show()}else{o.hide()}}).click(function(){if(t.attr("checked")&&!q.next().get(0)){new e(n)}}),j=w.find("button.delete").hide().click(function(){if(!confirm(DELETE_GROUP_PROMPT)){return false}f.splice(u-1,1);q.fadeRemove("fast",function(){if(f.length>1){n.find("li.stage").addClass("advance").last().removeClass("advance")}else{n.removeClass("steps").find("li.stage:last").removeClass("advance")}n.find("li.stage div.label").trigger("relabel")})}),m=function(A){var z=[];d.each(A,function(C,B){if("content"==C){z=B}if("rules"!=C){return}d.each(B,function(E,D){d.each(D,function(F,G){new c(p,G.name,G.value,u,z[G.id])})});p.trigger("rule-change",[C]);z=[]});if(A.settings){d.each(A.settings,function(C,D){var B=r.find("."+C);if(B.is("input[type=checkbox]")&&D==B.val()){B.attr("checked",true)}if(B.is("select")){B.val(D)}B.change()})}};w.hover(function(){if(q.prev().get(0)){j.show()}},function(){j.fadeOut("fast")});p.bind("rule-change",function(E,A,z){var B=d(this).find("li."+A+" div.ui select.access"),D=[],C=false;B.each(function(H,G){var F=d(G).find("option:selected").attr("class");if(d.inArray(F,D)==-1){D.push(F)}});B.find("option").attr("disabled",false);B.each(function(J,I){var H=d(I),G=J==0?1:0,F=D[G];if(!F){return}H.find("option."+F).attr("disabled",true);if(H.find("option:selected").attr("disabled")){H.find("option:enabled:first").attr("selected",true);C=true}});if(D.length==2){v.find("option[value="+A+"]").attr("disabled",true)}else{v.find("option[value="+A+"]").attr("disabled",false)}if(C){p.trigger("rule-change",[A])}});w.bind("relabel",function(){var z=(f.length>1?STAGES_LABEL:STAGE_LABEL);w.find("label").html(z)}).trigger("relabel");if(f.length>1){n.addClass("steps").find("li.stage").addClass("advance").find("div.label").trigger("relabel")}if(y){m(y)}q.appendTo(n).parent().sortable("refresh");t.change()}d.template("panelUI",d("#panelUI"));d.template("stagePanelControls",d("#stagePanelControls"));d.template("billPeriodOptions",d("#billPeriodOptions"));d.template("accessMenu",d("#accessMenu"));d("#add-stage").click(function(){new e(a)});if(rules){d.each(rules,function(g,h){new e(a,h)})}else{new e(a)}a.sortable({axis:"y",handle:"div.label",update:function(h,g){if(f.length>1){a.find("li.stage").addClass("advance").last().removeClass("advance").find("input.advance").attr("checked",false).change()}}})});