/*!
 * editor.js - Product editor behaviors
 * Copyright Â© 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 (or later) {@see license.txt}
 **/
;var Pricelines=new Pricelines(),productOptions=new Array(),productAddons=new Array(),optionMenus=new Array(),addonGroups=new Array(),addonOptionsGroup=new Array(),selectedMenuOption=false,detailsidx=1,variationsidx=1,addon_group_idx=1,addonsidx=1,optionsidx=1,pricingidx=1,fileUploader=false,changes=false,saving=false,flashUploader=false,template=false,fileUploads=false,changesMade=false,isSave=false;jQuery(document).ready(function(b){var d=b("#title"),c=b("#title-prompt-text"),a=b(".publishdate");d.bind("focus keydown",function(){c.hide()}).blur(function(){if(d.val()==""){c.show()}else{c.hide()}});if(!product){d.focus();c.show()}postboxes.add_postbox_toggles(screenid);b(".if-js-closed").removeClass("if-js-closed").addClass("closed");b(".postbox a.help").click(function(){b(this).colorbox({iframe:true,open:true,innerWidth:768,innerHeight:480,scrolling:false});return false});b('<div id="publish-calendar" class="calendar"></div>').appendTo("#wpwrap").PopupCalendar({m_input:b("#publish-month"),d_input:b("#publish-date"),y_input:b("#publish-year"),autoinit:true,title:calendarTitle,startWeek:startWeekday});b("#schedule-toggle").click(function(){b("#scheduling").slideToggle("fast",function(){if(b(this).is(":visible")){a.removeAttr("disabled")}else{a.attr("disabled",true)}})});b("#scheduling").hide();a.attr("disabled",true);b("#published").change(function(){if(b(this).prop("checked")){b("#publish-status,#schedule-toggling").show()}else{b("#publish-status,#schedule-toggling,#scheduling").hide()}}).change();b("#process-time").change(function(){var e=b("#processing");if(b(this).prop("checked")){e.slideDown("fast")}else{e.hide()}}).change();editslug=new SlugEditor(product,"product");if(specs){b.each(specs,function(){addDetail(this)})}b("#addDetail").click(function(){addDetail()});fileUploads=new FileUploader("flash-upload-file",b("#ajax-upload-file"));basePrice=b(prices).get(0);if(basePrice&&basePrice.context=="product"){Pricelines.add(false,basePrice,"#product-pricing")}else{Pricelines.add(false,false,"#product-pricing")}b("#variations-setting").bind("toggleui",variationsToggle).click(function(){b(this).trigger("toggleui")}).trigger("toggleui");loadVariations(!options||(!options.v&&!options.a)?options:options.v,prices);b("#addVariationMenu").click(function(){addVariationOptionsMenu()});b("#linkOptionVariations").click(linkVariationsButton).change(linkVariationsButtonLabel);b("#addons-setting").bind("toggleui",addonsToggle).click(function(){b(this).trigger("toggleui")}).trigger("toggleui");b("#newAddonGroup").click(function(){newAddonGroup()});if(options&&options.a){loadAddons(options.a,prices)}imageUploads=new ImageUploads(b("#image-product-id").val(),"product");categories();tags();quickSelects();b("#product").change(function(){changes=true}).unbind("submit").submit(function(h){h.stopPropagation();var f=b("#product").attr("action").split("?"),g=f[0]+"?"+b.param(request);b("#product")[0].setAttribute("action",g);saving=true;return true});b("#prices-loading").remove();b("input").on("change",function(){changesMade=true;b(this).off("change")});b("input[name='save']").click(function(){isSave=true});window.onbeforeunload=function(){var e=(typeof(tinymce)!="undefined")?tinymce.activeEditor:false;if(!isSave&&(changesMade||(e&&e.isDirty()&&!e.isHidden()))){return $msg.confirm}}});function categories(){var a=jQuery;a("#product .category-metabox").each(function(){var f=a(this),b=a(this).attr("id").split("-").slice(1).join("-"),d=b+"_tab",i=f.find("div.new-category").hide(),g=f.find("ul.category-tabs"),c=g.find("li a").click(function(l){l.preventDefault();var k=a(this),j=k.attr("href");k.parent().addClass("tabs").siblings("li").removeClass("tabs");a(j).show().siblings("div.tabs-panel").hide();if(k.parent().hasClass("new-category")){i.slideDown("fast",function(){i.find("input").focus()})}else{i.hide()}}),e=function(j){if(!a("#new-"+b+"-name").val()){return false}j.data+="&"+a(":checked","#"+b+"-checklist").serialize();a("#"+b+"-add-submit").prop("disabled",true);return j},h=function(m,l){var k,j=a("#new"+b+"_parent");a("#"+b+"-add-submit").prop("disabled",false);if("undefined"!=l.parsed.responses[0]&&(k=l.parsed.responses[0].supplemental.newcat_parent)){j.before(k);j.remove()}};a("#"+b+"-checklist").wpList({alt:"",response:b+"-ajax-response",addBefore:e,addAfter:h});g.find("li.tabs a").click();a("#"+b+"-checklist li.popular-category :checkbox, #"+b+"-checklist-pop :checkbox").on("click",function(){var j=a(this),l=j.is(":checked"),k=j.val();if(k&&j.parents("#taxonomy-"+b).length){a("#in-"+b+"-"+k+", #in-popular-"+b+"-"+k).attr("checked",l)}})});a(".category-metabox input[type=checkbox]").change(function(){if(!this.checked){return true}var c,b=new Array();a("#details-menu").children().children().find("input.label").each(function(e,d){b.push(a(d).val())});c=a(this).val();a.getJSON(spectemp_url+"&action=shopp_spec_template&category="+c,function(d){if(!d){return true}for(c in d){d[c].add=true;if(b.toString().search(d[c]["name"])==-1){addDetail(d[c])}}});a.getJSON(opttemp_url+"&action=shopp_options_template&category="+c,function(e){if(!(e&&(e.options&&e.prices)&&(Object.keys(e.options).length>0||Object.keys(e.prices).length>0))){return true}var g=a("#variations-setting"),d=!e.options.v?e.options:e.options.v,f=false;if(!g.attr("checked")){g.attr("checked",true).trigger("toggleui")}if(optionMenus.length>0){a.each(d,function(i,h){if(!(h&&h.name&&h.options)){return}if(menu=optionMenuExists(h.name)){f=false;a.each(h.options,function(j,k){if(!(k&&k.name)){return}if(!optionMenuItemExists(menu,k.name)){menu.addOption(k);f=true}});if(f){addVariationPrices()}}else{delete h.id;a.each(h.options,function(j,k){if(!(k&&k.name)){return}delete k.id});addVariationOptionsMenu(h)}})}else{loadVariations(d,e.prices)}})})}function tags(){var a=jQuery;a("#product .tags-metabox").each(function(){var f=a(this),d=a(this).attr("id").split("-").slice(1).join("-"),c=f.find(".tags"),e=c.val().split(","),b=new SearchSelector({source:d,parent:f,url:tagsugg_url,fieldname:"tax_input["+d+"]",label:TAG_SEARCHSELECT_LABEL,classname:"tags",freeform:true,autosuggest:"shopp_popular_tags"});c.val("");a.each(e,function(h,g){if(g.length==0){return}b.ui.prepend(b.newItem("",g))})})};